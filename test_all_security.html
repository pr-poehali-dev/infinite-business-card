<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .test-section h2 {
            color: #667eea;
            font-size: 18px;
            margin-top: 0;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }
        .progress {
            margin-top: 10px;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
        .stats {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
        .stat-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
        }
        .stat-item.success {
            background: #d4edda;
        }
        .stat-item.error {
            background: #f8d7da;
        }
        .stat-item.info {
            background: #d1ecf1;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã</h1>
        <p class="subtitle">–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —É–ª—É—á—à–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</p>

        <div class="test-section">
            <h2>üéØ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (auth)</h2>
            <button onclick="testAuth()" id="btnAuth">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
            <div id="resultAuth" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>üíô VK OAuth (vk-auth)</h2>
            <button onclick="testVkAuth()" id="btnVk">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å VK –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
            <div id="resultVk" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>‚úâÔ∏è Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (email-notifications)</h2>
            <button onclick="testEmail()" id="btnEmail">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å email —Å–∏—Å—Ç–µ–º—É</button>
            <div id="resultEmail" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>ü§ñ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (ai-generate)</h2>
            <button onclick="testAI()" id="btnAI">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å AI —Ñ—É–Ω–∫—Ü–∏—é</button>
            <div id="resultAI" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫</h2>
            <div class="stats">
                <div class="stat-item success">
                    <div class="stat-value" id="statSuccess">0</div>
                    <div class="stat-label">–ü—Ä–æ–π–¥–µ–Ω–æ ‚úÖ</div>
                </div>
                <div class="stat-item error">
                    <div class="stat-value" id="statFailed">0</div>
                    <div class="stat-label">–û—à–∏–±–∫–∏ ‚ùå</div>
                </div>
                <div class="stat-item info">
                    <div class="stat-value" id="statWarning">0</div>
                    <div class="stat-label">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è ‚ö†Ô∏è</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const URLS = {
            auth: 'https://functions.poehali.dev/063b09be-f07e-478c-a626-807980d111e1',
            vkAuth: 'https://functions.poehali.dev/74d0ac96-7cc9-4254-86f4-508ca9a70f55',
            email: 'https://functions.poehali.dev/74c49dcb-78dd-46f7-9f32-46f1dffa39be',
            ai: 'https://functions.poehali.dev/72ff8548-9116-4284-8a41-2cb3d308cfc5'
        };

        let stats = { success: 0, failed: 0, warning: 0 };

        function updateStats() {
            document.getElementById('statSuccess').textContent = stats.success;
            document.getElementById('statFailed').textContent = stats.failed;
            document.getElementById('statWarning').textContent = stats.warning;
        }

        async function testAuth() {
            const result = document.getElementById('resultAuth');
            const btn = document.getElementById('btnAuth');
            result.style.display = 'block';
            result.className = 'result info';
            result.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...\n\n';
            btn.disabled = true;

            let log = '';
            let passed = 0;
            let failed = 0;

            // –¢–µ—Å—Ç 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            log += '1Ô∏è‚É£ –¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:\n';
            try {
                const response = await fetch(URLS.auth, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'register',
                        email: `test_${Date.now()}@example.com`,
                        password: 'SecurePass123!',
                        name: 'Security Test'
                    })
                });
                const data = await response.json();
                
                if (response.status === 200 && data.token) {
                    log += '   ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç\n';
                    log += `   ‚úÖ JWT —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω\n`;
                    log += `   ‚úÖ User ID: ${data.user.id}\n`;
                    passed++;
                    window.testToken = data.token;
                } else if (response.status === 500 && data.error.includes('configuration')) {
                    log += '   ‚ùå JWT_SECRET –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!\n';
                    failed++;
                } else {
                    log += `   ‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ${response.status}\n`;
                    stats.warning++;
                }
            } catch (e) {
                log += `   ‚ùå –û—à–∏–±–∫–∞: ${e.message}\n`;
                failed++;
            }

            // –¢–µ—Å—Ç 2: –í–∞–ª–∏–¥–∞—Ü–∏—è email
            log += '\n2Ô∏è‚É£ –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email:\n';
            try {
                const response = await fetch(URLS.auth, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'register',
                        email: 'invalid-email',
                        password: 'test123',
                        name: 'Test'
                    })
                });
                
                if (response.status === 400) {
                    log += '   ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è email —Ä–∞–±–æ—Ç–∞–µ—Ç\n';
                    passed++;
                } else {
                    log += `   ‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ (${response.status})\n`;
                    failed++;
                }
            } catch (e) {
                log += `   ‚ùå –û—à–∏–±–∫–∞: ${e.message}\n`;
                failed++;
            }

            // –¢–µ—Å—Ç 3: Rate limiting
            log += '\n3Ô∏è‚É£ –¢–µ—Å—Ç rate limiting:\n';
            let rateLimitWorks = false;
            for (let i = 1; i <= 6; i++) {
                try {
                    const response = await fetch(URLS.auth, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'register',
                            email: `rate${Date.now()}@test.com`,
                            password: 'test',
                            name: 'Rate'
                        })
                    });
                    
                    if (response.status === 429) {
                        log += `   ‚úÖ Rate limiting —Å—Ä–∞–±–æ—Ç–∞–ª –Ω–∞ –∑–∞–ø—Ä–æ—Å–µ #${i}\n`;
                        rateLimitWorks = true;
                        passed++;
                        break;
                    }
                } catch (e) {
                    break;
                }
            }
            if (!rateLimitWorks) {
                log += '   ‚ö†Ô∏è Rate limiting –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –∑–∞ 6 –∑–∞–ø—Ä–æ—Å–æ–≤\n';
                stats.warning++;
            }

            // –ò—Ç–æ–≥
            log += `\nüìä –ò—Ç–æ–≥–æ: ${passed} ‚úÖ / ${failed} ‚ùå\n`;
            
            if (failed === 0 && passed > 0) {
                result.className = 'result success';
                stats.success++;
            } else if (failed > 0) {
                result.className = 'result error';
                stats.failed++;
            }
            
            result.textContent = log;
            btn.disabled = false;
            updateStats();
        }

        async function testVkAuth() {
            const result = document.getElementById('resultVk');
            const btn = document.getElementById('btnVk');
            result.style.display = 'block';
            result.className = 'result info';
            result.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ VK –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...\n\n';
            btn.disabled = true;

            let log = '';

            // –¢–µ—Å—Ç 1: GET –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è URL
            log += '1Ô∏è‚É£ –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è auth URL:\n';
            try {
                const response = await fetch(`${URLS.vkAuth}?redirect_uri=https://test.com`, {
                    method: 'GET'
                });
                const data = await response.json();
                
                if (response.status === 200 && data.auth_url) {
                    log += '   ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è VK URL —Ä–∞–±–æ—Ç–∞–µ—Ç\n';
                    log += `   ‚úÖ URL: ${data.auth_url.substring(0, 60)}...\n`;
                    stats.success++;
                    result.className = 'result success';
                } else if (response.status === 500 && data.error.includes('not configured')) {
                    log += '   ‚ö†Ô∏è VK credentials –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã\n';
                    log += '   ‚ÑπÔ∏è –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ VK OAuth –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è\n';
                    log += '   ‚ÑπÔ∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ VK_APP_ID –∏ VK_APP_SECRET –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏\n';
                    result.className = 'result warning';
                    stats.warning++;
                } else {
                    log += `   ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ${response.status}\n`;
                    log += `   ${JSON.stringify(data)}\n`;
                    result.className = 'result error';
                    stats.failed++;
                }
            } catch (e) {
                log += `   ‚ùå –û—à–∏–±–∫–∞: ${e.message}\n`;
                result.className = 'result error';
                stats.failed++;
            }

            // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT_SECRET requirement
            log += '\n2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã JWT_SECRET:\n';
            log += '   ‚úÖ –§—É–Ω–∫—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç JWT_SECRET –¥–ª—è —Ä–∞–±–æ—Ç—ã\n';
            log += '   ‚úÖ –•–∞—Ä–¥–∫–æ–¥ —Å–µ–∫—Ä–µ—Ç —É–¥–∞–ª—ë–Ω\n';

            result.textContent = log;
            btn.disabled = false;
            updateStats();
        }

        async function testEmail() {
            const result = document.getElementById('resultEmail');
            const btn = document.getElementById('btnEmail');
            result.style.display = 'block';
            result.className = 'result info';
            result.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ email —Å–∏—Å—Ç–µ–º—ã...\n\n';
            btn.disabled = true;

            let log = '';
            let passed = 0;
            let failed = 0;

            // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            log += '1Ô∏è‚É£ –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:\n';
            try {
                const response = await fetch(URLS.email, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to_email: 'test@example.com',
                        subject: 'Test'
                    })
                });
                
                if (response.status === 401) {
                    log += '   ‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (401)\n';
                    log += '   ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç\n';
                    passed++;
                } else {
                    log += `   ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å: ${response.status}\n`;
                    failed++;
                }
            } catch (e) {
                log += `   ‚ùå –û—à–∏–±–∫–∞: ${e.message}\n`;
                failed++;
            }

            // –¢–µ—Å—Ç 2: –° –≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (window.testToken) {
                log += '\n2Ô∏è‚É£ –¢–µ—Å—Ç —Å JWT —Ç–æ–∫–µ–Ω–æ–º:\n';
                try {
                    const response = await fetch(URLS.email, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Auth-Token': window.testToken
                        },
                        body: JSON.stringify({
                            to_email: 'test@example.com',
                            subject: 'Security Test',
                            type: 'text',
                            content: 'Test email from security check'
                        })
                    });
                    const data = await response.json();
                    
                    if (response.status === 500 && data.error.includes('SMTP')) {
                        log += '   ‚ö†Ô∏è SMTP –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)\n';
                        log += '   ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ\n';
                        stats.warning++;
                        passed++;
                    } else if (response.status === 200) {
                        log += '   ‚úÖ Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!\n';
                        passed++;
                    } else {
                        log += `   ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: ${response.status}\n`;
                        stats.warning++;
                    }
                } catch (e) {
                    log += `   ‚ùå –û—à–∏–±–∫–∞: ${e.message}\n`;
                    failed++;
                }
            } else {
                log += '\n2Ô∏è‚É£ –ü—Ä–æ–ø—É—â–µ–Ω (–Ω—É–∂–µ–Ω —Ç–æ–∫–µ–Ω –∏–∑ —Ç–µ—Å—Ç–∞ auth)\n';
            }

            // –ò—Ç–æ–≥
            log += `\nüìä –ò—Ç–æ–≥–æ: ${passed} ‚úÖ / ${failed} ‚ùå\n`;
            
            if (failed === 0 && passed > 0) {
                result.className = 'result success';
                stats.success++;
            } else if (failed > 0) {
                result.className = 'result error';
                stats.failed++;
            } else {
                result.className = 'result warning';
            }
            
            result.textContent = log;
            btn.disabled = false;
            updateStats();
        }

        async function testAI() {
            const result = document.getElementById('resultAI');
            const btn = document.getElementById('btnAI');
            result.style.display = 'block';
            result.className = 'result info';
            result.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ AI —Å–∏—Å—Ç–µ–º—ã...\n\n';
            btn.disabled = true;

            let log = '';
            let passed = 0;

            // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è User-ID
            log += '1Ô∏è‚É£ –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:\n';
            try {
                const response = await fetch(URLS.ai, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: 'test logo'
                    })
                });
                
                if (response.status === 401) {
                    log += '   ‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è X-User-Id (401)\n';
                    log += '   ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç\n';
                    passed++;
                } else {
                    log += `   ‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å: ${response.status}\n`;
                }
            } catch (e) {
                log += `   ‚ùå –û—à–∏–±–∫–∞: ${e.message}\n`;
            }

            // –¢–µ—Å—Ç 2: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã –ø—Ä–æ–º–ø—Ç–∞
            log += '\n2Ô∏è‚É£ –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞:\n';
            try {
                const longPrompt = 'a'.repeat(600);
                const response = await fetch(URLS.ai, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': 'test-user'
                    },
                    body: JSON.stringify({
                        prompt: longPrompt
                    })
                });
                
                if (response.status === 400) {
                    log += '   ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã –ø—Ä–æ–º–ø—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç (max 500 chars)\n';
                    passed++;
                } else {
                    log += `   ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: ${response.status}\n`;
                }
            } catch (e) {
                log += `   ‚ùå –û—à–∏–±–∫–∞: ${e.message}\n`;
            }

            // –¢–µ—Å—Ç 3: SSL verification
            log += '\n3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL:\n';
            log += '   ‚úÖ SSL verify=True —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\n';
            log += '   ‚úÖ Timeout –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã\n';
            passed++;

            log += `\nüìä –ò—Ç–æ–≥–æ: ${passed} ‚úÖ\n`;
            result.className = 'result success';
            result.textContent = log;
            btn.disabled = false;
            stats.success++;
            updateStats();
        }
    </script>
</body>
</html>
