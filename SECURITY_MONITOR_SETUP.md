# üîê Security Monitor - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

## –û–±–∑–æ—Ä

Security Monitor - —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç 5 backend —Ñ—É–Ω–∫—Ü–∏–π (auth, vk-auth, email-notifications, ai-generate, leads)
- ‚úÖ –í—ã–ø–æ–ª–Ω—è–µ—Ç 13 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Å –æ—Ü–µ–Ω–∫–æ–π –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## URL —Ñ—É–Ω–∫—Ü–∏–∏

```
https://functions.poehali.dev/89e7e273-4388-4149-8e3e-7a1caf667d5b
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä—É—á–Ω—É—é

**HTTP –∑–∞–ø—Ä–æ—Å:**
```bash
curl https://functions.poehali.dev/89e7e273-4388-4149-8e3e-7a1caf667d5b
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "timestamp": "2025-12-17T13:11:21.135512",
  "total_checks": 13,
  "passed": 11,
  "failed": 0,
  "warnings": 2,
  "security_score": 84.6,
  "status": "good",
  "functions": {
    "auth": { ... },
    "vk-auth": { ... },
    "email-notifications": { ... },
    "ai-generate": { ... },
    "leads": { ... }
  }
}
```

### 2. –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (Dashboard)

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `security-monitor-dashboard.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è:
- üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
- üì• –≠–∫—Å–ø–æ—Ä—Ç–∞ –æ—Ç—á—ë—Ç–æ–≤ –≤ .txt —Ñ–æ—Ä–º–∞—Ç

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Cron)

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –∫ —Ñ—É–Ω–∫—Ü–∏–∏ —á–µ—Ä–µ–∑:

**Linux/Mac (crontab):**
```bash
# –ö–∞–∂–¥—ã–π —á–∞—Å
0 * * * * curl -s https://functions.poehali.dev/89e7e273-4388-4149-8e3e-7a1caf667d5b > /dev/null
```

**GitHub Actions (.github/workflows/security-check.yml):**
```yaml
name: Security Monitor
on:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:

jobs:
  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Run security check
        run: |
          curl -s https://functions.poehali.dev/89e7e273-4388-4149-8e3e-7a1caf667d5b
```

## Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?

Email –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—Å–ª–∏:
- üö® –£—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ < 75%
- ‚ùå –ï—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ (failed > 0)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SMTP –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å–µ–∫—Ä–µ—Ç—ã SMTP (–∏–∑ `SECRETS_SETUP.md`):

1. **SMTP_HOST** - —Å–µ—Ä–≤–µ—Ä SMTP (–Ω–∞–ø—Ä–∏–º–µ—Ä, `smtp.yandex.ru`)
2. **SMTP_PORT** - –ø–æ—Ä—Ç (–æ–±—ã—á–Ω–æ `465` –¥–ª—è SSL)
3. **SMTP_USER** - –≤–∞—à email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
4. **SMTP_PASSWORD** - –ø–∞—Ä–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
5. **ADMIN_EMAIL** - email –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä –ø–∏—Å—å–º–∞:**
```
Subject: üö® Security Alert: 60.5% | 2 Failed

–£—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: 60.5%
–°—Ç–∞—Ç—É—Å: needs_improvement
–ü—Ä–æ–≤–µ—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω–æ: 8/13
–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: 3
–û—à–∏–±–æ–∫: 2

–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
‚ùå auth: Email validation - Validation not working
‚ö†Ô∏è ai-generate: Rate limiting - Not triggered
```

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–ï—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç—ã SMTP –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã. –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–µ–∑ API.

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è?

### auth (3 –ø—Ä–æ–≤–µ—Ä–∫–∏)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è email —Ñ–æ—Ä–º–∞—Ç–∞
- ‚úÖ Rate limiting (5 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É)
- ‚úÖ JWT —Ç–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ JWT_SECRET

### vk-auth (2 –ø—Ä–æ–≤–µ—Ä–∫–∏)
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è VK OAuth URL
- ‚úÖ –ó–∞—â–∏—Ç–∞ JWT_SECRET (–Ω–µ—Ç —Ö–∞—Ä–¥–∫–æ–¥–∞)

### email-notifications (2 –ø—Ä–æ–≤–µ—Ä–∫–∏)
- ‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (X-Auth-Token)
- ‚úÖ Rate limiting (10 email/–º–∏–Ω—É—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

### ai-generate (3 –ø—Ä–æ–≤–µ—Ä–∫–∏)
- ‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ X-User-Id –∑–∞–≥–æ–ª–æ–≤–∫–∞
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã –ø—Ä–æ–º–ø—Ç–∞ (max 500 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ SSL verification –≤–∫–ª—é—á–µ–Ω

### leads (3 –ø—Ä–æ–≤–µ—Ä–∫–∏)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è email —Ñ–æ—Ä–º–∞—Ç–∞
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)
- ‚úÖ Rate limiting (3 –∑–∞–ø—Ä–æ—Å–∞/–º–∏–Ω—É—Ç—É)

## –°—Ç–∞—Ç—É—Å—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

| –£—Ä–æ–≤–µ–Ω—å | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|--------|----------|
| 90-100% | `excellent` üåü | –û—Ç–ª–∏—á–Ω–∞—è –∑–∞—â–∏—Ç–∞ |
| 75-89% | `good` ‚úÖ | –•–æ—Ä–æ—à–∞—è –∑–∞—â–∏—Ç–∞ |
| 50-74% | `needs_improvement` ‚ö†Ô∏è | –¢—Ä–µ–±—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏–µ |
| 0-49% | `critical` üö® | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã |

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ CI/CD

### –ü—Ä–∏–º–µ—Ä —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

```bash
#!/bin/bash
# check-security.sh

SECURITY_URL="https://functions.poehali.dev/89e7e273-4388-4149-8e3e-7a1caf667d5b"
MIN_SCORE=75

echo "üîç Checking security status..."
RESPONSE=$(curl -s $SECURITY_URL)
SCORE=$(echo $RESPONSE | jq -r '.security_score')
FAILED=$(echo $RESPONSE | jq -r '.failed')

echo "Security Score: $SCORE%"
echo "Failed Checks: $FAILED"

if (( $(echo "$SCORE < $MIN_SCORE" | bc -l) )) || [ "$FAILED" -gt 0 ]; then
    echo "‚ùå Security check failed!"
    echo "Minimum required: $MIN_SCORE%"
    exit 1
fi

echo "‚úÖ Security check passed!"
exit 0
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
chmod +x check-security.sh
./check-security.sh && echo "Deploy allowed" || echo "Deploy blocked"
```

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

–û—Ç–∫—Ä–æ–π—Ç–µ `backend/security-monitor/index.py` –∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏:

```python
def check_my_function_security(url: str) -> Dict[str, Any]:
    result = {
        'total_checks': 2,
        'passed': 0,
        'failed': 0,
        'warnings': 0,
        'checks': []
    }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1
    try:
        response = requests.post(url, json={'test': 'data'}, timeout=5)
        if response.status_code == 401:
            result['checks'].append({
                'name': 'Authentication',
                'status': 'passed',
                'message': 'Auth required'
            })
            result['passed'] += 1
    except Exception as e:
        result['checks'].append({
            'name': 'Authentication',
            'status': 'error',
            'message': str(e)[:100]
        })
        result['failed'] += 1
    
    return result
```

–ó–∞—Ç–µ–º –¥–æ–±–∞–≤—å—Ç–µ –≤—ã–∑–æ–≤ –≤ —Ñ—É–Ω–∫—Ü–∏—é `handler`:

```python
my_result = check_my_function_security(functions['my-function'])
results['functions']['my-function'] = my_result
results['total_checks'] += my_result['total_checks']
results['passed'] += my_result['passed']
results['failed'] += my_result['failed']
results['warnings'] += my_result['warnings']
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–í —Ñ–∞–π–ª–µ `backend/security-monitor/index.py` –Ω–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É:

```python
if results['security_score'] < 75 or results['failed'] > 0:
    send_alert_email(results)
```

–ò–∑–º–µ–Ω–∏—Ç–µ `75` –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `80` –¥–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–≥–æ –ø–æ—Ä–æ–≥–∞).

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å–µ–∫—Ä–µ—Ç–æ–≤ SMTP
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ < 75% –∏–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–∏:
```bash
# –í poehali.dev –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ get_logs tool
get_logs backend/security-monitor
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–≤–µ—Ä–Ω—ã–π security_score

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (JWT_SECRET –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–µ–Ω)
3. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (warnings) - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (VK OAuth, SMTP)

### –ü—Ä–æ–±–ª–µ–º–∞: Timeout –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**
–£–≤–µ–ª–∏—á—å—Ç–µ timeout –≤ –∫–æ–¥–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 —Å–µ–∫—É–Ω–¥):
```python
response = requests.post(url, json={...}, timeout=10)  # –£–≤–µ–ª–∏—á–µ–Ω –¥–æ 10 —Å–µ–∫
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- üìÑ `SECURITY_IMPROVEMENTS_SUMMARY.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –ø–æ —É–ª—É—á—à–µ–Ω–∏—è–º
- üìÑ `SECRETS_SETUP.md` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- üìÑ `SECURITY_AUDIT_REPORT.md` - –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- üåê `security-monitor-dashboard.html` - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- üåê `test_all_security.html` - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- üåê `quick_auth_test.html` - –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:
- Telegram: https://t.me/+QgiLIa1gFRY4Y2Iy
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://docs.poehali.dev
